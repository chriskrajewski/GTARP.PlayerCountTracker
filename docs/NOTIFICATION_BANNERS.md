# Notification Banner System Documentation

## Overview

The Notification Banner System provides a comprehensive solution for displaying important updates, announcements, and alerts to users across the GTA RP Player Count Tracker application. This system includes full CRUD operations, user dismissal tracking, scheduling capabilities, and a powerful admin interface.

## Table of Contents

1. [Architecture Overview](#architecture-overview)
2. [Database Schema](#database-schema)
3. [API Endpoints](#api-endpoints)
4. [React Components](#react-components)
5. [Admin Interface](#admin-interface)
6. [Usage Examples](#usage-examples)
7. [Configuration](#configuration)
8. [Deployment](#deployment)

## Architecture Overview

The notification banner system consists of several interconnected components:

### Core Components
- **Database Layer**: PostgreSQL tables for banner data and user dismissals
- **API Layer**: RESTful endpoints for banner management
- **React Components**: UI components for displaying and managing banners
- **State Management**: React hooks for banner state and user interactions
- **Feature Gates**: Statsig integration for feature toggle control

### Data Flow
1. Banners are created via the admin interface
2. API stores banner data in Supabase database
3. Client fetches active banners on page load
4. Components render banners based on priority and user dismissal status
5. User interactions (dismissals) are tracked and stored

## Database Schema

### notification_banners Table
```sql
CREATE TABLE public.notification_banners (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
  
  -- Content
  title TEXT NOT NULL,
  message TEXT NOT NULL,
  type TEXT NOT NULL DEFAULT 'info' CHECK (type IN ('info', 'warning', 'success', 'announcement', 'urgent')),
  
  -- Display Settings
  priority INTEGER NOT NULL DEFAULT 1,
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  is_dismissible BOOLEAN NOT NULL DEFAULT TRUE,
  
  -- Scheduling
  start_date TIMESTAMP WITH TIME ZONE NULL,
  end_date TIMESTAMP WITH TIME ZONE NULL,
  
  -- Action Button
  action_text TEXT NULL,
  action_url TEXT NULL,
  action_target TEXT NULL DEFAULT '_self',
  
  -- Customization
  background_color TEXT NULL,
  text_color TEXT NULL,
  border_color TEXT NULL,
  
  -- Metadata
  created_by TEXT NULL,
  view_count BIGINT DEFAULT 0,
  dismiss_count BIGINT DEFAULT 0
);
```

### notification_banner_dismissals Table
```sql
CREATE TABLE public.notification_banner_dismissals (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  banner_id BIGINT NOT NULL REFERENCES notification_banners(id) ON DELETE CASCADE,
  user_id TEXT NOT NULL,
  dismissed_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
  
  UNIQUE(banner_id, user_id)
);
```

## API Endpoints

### GET /api/notification-banners
Fetches active notification banners for the current user.

**Query Parameters:**
- `include_inactive` (boolean): Include inactive banners (admin only)

**Response:**
```json
{
  "banners": [
    {
      "id": 1,
      "title": "Welcome!",
      "message": "Welcome to our new site!",
      "type": "info",
      "priority": 5,
      "is_active": true,
      "is_dismissible": true,
      // ... other fields
    }
  ],
  "total": 1
}
```

### POST /api/notification-banners
Creates a new notification banner.

**Request Body:**
```json
{
  "title": "System Maintenance",
  "message": "Scheduled maintenance tonight 2-4 AM EST",
  "type": "warning",
  "priority": 8,
  "is_active": true,
  "is_dismissible": true,
  "start_date": "2024-01-15T02:00:00Z",
  "end_date": "2024-01-15T04:00:00Z"
}
```

### PUT /api/notification-banners?id={id}
Updates an existing notification banner.

### DELETE /api/notification-banners?id={id}
Deletes a notification banner.

### POST /api/notification-banners/dismiss
Dismisses a banner for the current user.

**Request Body:**
```json
{
  "banner_id": 1
}
```

### GET /api/notification-banners/dismiss
Gets user's dismissed banners.

## React Components

### NotificationBanner
Main component for displaying individual banners.

**Props:**
```tsx
interface NotificationBannerProps {
  banner: NotificationBanner;
  onDismiss?: (bannerId: number) => void;
  className?: string;
}
```

**Features:**
- Smooth animations and transitions
- Custom styling support
- Responsive design
- Accessibility compliance
- Action button support

### NotificationBannerList
Container component for managing multiple banners.

**Props:**
```tsx
interface NotificationBannerListProps {
  banners: NotificationBanner[];
  onDismiss?: (bannerId: number) => void;
  maxVisible?: number;
  className?: string;
}
```

**Features:**
- Priority-based sorting
- Configurable display limits
- Staggered animations
- Automatic filtering of dismissed banners

### useNotificationBanners Hook
Custom hook for banner state management.

**Returns:**
```tsx
{
  banners: NotificationBanner[];
  loading: boolean;
  error: string | null;
  refetch: () => Promise<void>;
  dismissBanner: (bannerId: number) => Promise<void>;
}
```

### AdminBannerControls
Comprehensive admin interface for banner management.

**Features:**
- Banner creation and editing forms
- Real-time preview
- Bulk operations
- Statistics dashboard
- Color customization
- Scheduling interface

## Admin Interface

The admin interface is accessible at `/admin/banners` and is protected by token-based authentication. You must set the `ADMIN_TOKEN` environment variable and authenticate with that token to access the admin features.

### Authentication Setup
```bash
# Set in your environment (.env.local)
ADMIN_TOKEN=your-secure-64-character-random-token-here
```

The admin interface provides:

### Banner Management
- **Create**: Form-based banner creation with validation
- **Edit**: In-place editing of existing banners
- **Delete**: Safe deletion with confirmation
- **Toggle**: Quick activate/deactivate banners

### Preview System
- Real-time preview while creating/editing
- Test different banner types and styles
- Responsive preview for mobile/desktop

### Analytics
- View count tracking
- Dismissal rate monitoring
- Performance metrics

### Scheduling
- Start/end date configuration
- Timezone handling
- Automatic activation/deactivation

## Usage Examples

### Basic Implementation
```tsx
import { NotificationBannerList, useNotificationBanners } from '@/components/notification-banner';

export function MyLayout({ children }) {
  const { banners, dismissBanner } = useNotificationBanners();
  
  return (
    <div>
      <NotificationBannerList 
        banners={banners} 
        onDismiss={dismissBanner}
        maxVisible={2}
      />
      {children}
    </div>
  );
}
```

### Custom Banner Types
```tsx
// Creating a custom urgent banner
const urgentBanner = {
  title: "Critical Alert",
  message: "System experiencing high load",
  type: "urgent",
  priority: 10,
  is_dismissible: false,
  background_color: "#dc2626",
  text_color: "#ffffff"
};
```

### API Usage
```typescript
// Create a new banner
const response = await fetch('/api/notification-banners', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    title: "New Feature",
    message: "Check out our latest update!",
    type: "announcement",
    priority: 3
  })
});

// Dismiss a banner
await fetch('/api/notification-banners/dismiss', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ banner_id: 1 })
});
```

## Configuration

### Feature Gates
The notification banner system is controlled by the `NOTIFICATION_BANNERS` feature gate in Statsig:

```typescript
import { useFeatureGate, FEATURE_GATES } from '@/lib/statsig';

const isEnabled = useFeatureGate(FEATURE_GATES.NOTIFICATION_BANNERS);
```

### Environment Variables
No additional environment variables are required as the system uses the existing Supabase configuration.

### Database Setup
Execute the schema file to set up the required tables:

```bash
psql -h your-db-host -U your-user -d your-db -f api2db/sql/notification_banners_schema.sql
```

## Deployment

### Prerequisites
1. Supabase database with notification banner tables
2. Next.js application with Supabase client configured
3. Statsig feature flag setup (optional)

### Deployment Steps
1. Run database migrations:
   ```sql
   -- Execute notification_banners_schema.sql
   ```

2. Deploy application with new components:
   ```bash
   npm run build
   npm run deploy
   ```

3. Configure feature flags in Statsig (if using):
   - Enable `enable_notification_banners` gate

### Post-Deployment Verification
1. Visit `/admin/banners` to access admin interface
2. Create a test banner
3. Verify banner appears on main pages
4. Test dismissal functionality
5. Check API endpoints respond correctly

### Row Level Security (RLS)
The system includes RLS policies for data protection:

```sql
-- Read access to active banners
CREATE POLICY "Allow public read on active banners" ON notification_banners
  FOR SELECT USING (
    is_active = TRUE 
    AND (start_date IS NULL OR start_date <= NOW()) 
    AND (end_date IS NULL OR end_date >= NOW())
  );

-- Dismissal tracking
CREATE POLICY "Allow dismissal tracking" ON notification_banner_dismissals
  FOR ALL USING (TRUE);
```

## Best Practices

### Content Guidelines
- **Titles**: Keep under 50 characters for readability
- **Messages**: Limit to 200 characters for mobile compatibility
- **Priority**: Use 1-10 scale, reserve 9-10 for emergencies
- **Types**: Choose appropriate banner type for content

### Performance Considerations
- Limit simultaneous banners (maxVisible=2 recommended)
- Use caching for frequently accessed banners
- Optimize images in banner content
- Monitor dismissal rates to gauge effectiveness

### Security Considerations
- Validate all user inputs
- Sanitize banner content to prevent XSS
- Use RLS policies for data access control
- Implement rate limiting for API endpoints

### Accessibility
- All banners include proper ARIA labels
- Color contrast meets WCAG 2.1 AA standards
- Keyboard navigation support
- Screen reader compatibility

## Troubleshooting

### Common Issues

**Banners not appearing:**
1. Check feature flag status
2. Verify banner is active and within date range
3. Check if user has dismissed the banner
4. Verify API endpoints are responding

**Admin interface not loading:**
1. Check user permissions
2. Verify API connectivity
3. Check browser console for errors
4. Validate database connectivity

**Performance issues:**
1. Check number of active banners
2. Monitor database query performance
3. Verify caching implementation
4. Check for memory leaks in React components

### Debug Mode
Enable debug logging by setting:
```typescript
const DEBUG_BANNERS = process.env.NODE_ENV === 'development';
```

## Future Enhancements

- **User Segmentation**: Target banners to specific user groups
- **A/B Testing**: Split test different banner variants
- **Rich Content**: Support for HTML content and media
- **Push Notifications**: Browser notification integration
- **Analytics Dashboard**: Enhanced metrics and reporting
- **Bulk Operations**: Import/export banner configurations
- **Templates**: Pre-built banner templates for common use cases
